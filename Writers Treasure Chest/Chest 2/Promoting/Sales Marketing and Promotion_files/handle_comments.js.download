var original_edit='';$(document).ready(function(){$(document).on("click",".edit_reply",function(){var comment_id=$(this).attr("data-comment_id");$(this).tooltip('hide');$('.js_reply_div').remove();if($(".js_wysiwyg_printout").find("#small_edit_live").length){var main=$(".js_wysiwyg_printout").find("#small_edit_live").parent();main.html(nl2br(original_edit));$(".js_comment_header_div").css("display",'');$('.js_wysiwyg_printout').addClass('comment_body');}
$('.comments_list .js_comments').removeClass('enter_comment');$('.js_comment_header_div').show();$(this).parents('.js_comments:first').find('.js_comment_section:first').find('.js_comment_header_div').hide();$(".js_edit_div").remove();var action=window['jsVars']['portal_path']+$(this).data("action");var edit_small_template=generate_form("small_edit_live",action,comment_id,0);edit_small_template.addClass("js_edit_div");$('.js_poster_img_form',edit_small_template).tooltip();$(edit_small_template).find(".js_poster_img_form").attr('src',$(this).parents('.js_comments').find('.js_poster_img').attr("src"));if(window['jsVars'].mobile_version==0){$(".js_post_comment_button",edit_small_template).text("Edit");}
$("#comment",edit_small_template).val(br2nl(empty_nl($(".js_wysiwyg_printout[data-comment_id='"+comment_id+"']").text().trim()))).css("height",'76px');original_edit=br2nl(empty_nl($(".js_wysiwyg_printout[data-comment_id='"+comment_id+"']").html().trim()));$(this).parents(".js_comments:first").find('.js_comment_section:first').after($(edit_small_template).hide().fadeIn('slow'))
$("#small_edit_live").addClass('enter_comment');$("#comment",edit_small_template).focus();validate_list_empty(JSON.parse($("#comment",edit_small_template).attr('data-validation_details')));$('.js_comments .js_comment_ta').css('overflow','hidden').autogrow();});$(document).on("click",".respond_reply",function(){var comment_id=$(this).attr("comment_id"),reply_to=$(this).attr("reply_to"),main_reply_to=$(this).attr("main_reply_to");$(this).tooltip('hide');if(reply_to==0){reply_to=main_reply_to;}
var action='{membership_portal_path_url}/'+$(this).data("action");$(".js_reply_div").remove();if($(".js_wysiwyg_printout").find("#small_edit_live").length){var main=$(".js_wysiwyg_printout").find("#small_edit_live").parent();main.html(nl2br(original_edit));$(".js_comment_header_div").css("display",'');$('.js_wysiwyg_printout').addClass('comment_body');}
var reply_small_template=$("#post_comment_div").clone();reply_small_template.addClass("js_reply_div reply_div");reply_small_template.addClass("js_comments");reply_small_template.removeAttr("id");if(window['jsVars'].mobile_version==0){$(".js_post_comment_button",reply_small_template).text("Reply");}
$("#reply_to",reply_small_template).val(reply_to);$("#main_reply_to",reply_small_template).val(main_reply_to);$("#the_form",reply_small_template).removeAttr("id").attr("id","the_form_clone");$("#the_form_clone",reply_small_template).removeAttr("name").attr("name","the_form_clone");$('.js_add_comment',reply_small_template).val('').attr('data-validation_details','{"selector": ".js_comments .js_add_comment", "button": ".js_comments .js_post_comment_button"}');if($(this).parents(".js_comments[data-comment_type='reply']:first").length){$(this).parents(".js_comments:first").parent().find("[data-comment_type='reply']:last").after($(reply_small_template).fadeIn('slow'));}else{if($(this).parents(".js_comments:first").children("ul").find("[data-comment_type='reply']").length){$(this).parents(".js_comments:first").children("ul").find("[data-comment_type='reply']:last").after($(reply_small_template).fadeIn('slow'));}else{$(this).parents(".js_comments:first").children("ul").append($(reply_small_template).hide().fadeIn('slow'))}}
$('[data-toggle="tooltip"]').tooltip();if('function'===typeof initConfirmActionPopovers){initConfirmActionPopovers();}
setTimeout(function(){$('html, body').animate({scrollTop:$(reply_small_template).offset().top-300},600);$("#comment",reply_small_template).focus();},100);validate_list_empty(JSON.parse($('.js_comments .js_add_comment').attr('data-validation_details')));$('.js_comments .js_comment_ta').css('overflow','hidden').autogrow();});$(document).on('click','.do_delete_reply, .delete_reply_mobile',function(){var $self=$(this);deleteComment($self);});$(document).on("click",".js_approve_link",function(){var $self=$(this),comment_id=$(this).attr("data-comment_id");if($self.hasClass('disabled')){return false;}
$self.tooltip('hide');$self.addClass('disabled');$.ajax({url:window['jsVars']['portal_path']+"approve_comment/",type:"POST",data:{comment_id:comment_id}}).done(function(data){$(".js_comments[data-comment_id='"+comment_id+"']").addClass("green_bg_highlight_1x");if($('.js_comments_approve_modal_div').length>0){setTimeout(function(){var $comment_container=$(".js_comments[data-comment_id='"+comment_id+"']"),$post_container=$comment_container.parents('.js_comments_approve_modal'),$removing_container=$comment_container;if($post_container.find('.js_comments').length===1){$removing_container=$post_container;}
$removing_container.fadeOut("normal",function(){$(this).remove();update_indicators();});},1000);}else{setTimeout(function(){var $commentHeader=$('.js_comments[data-comment_id="'+comment_id+'"] .js_comment_section:first .js_comment_header_div'),$approveLink=$('.js_approve_link_li',$commentHeader),$moderationElement=$('.js_moderation_element',$commentHeader);$self.tooltip('hide');$approveLink.fadeOut(300,function(){$approveLink.remove();$moderationElement.remove();});},1000);}})});$(document).on("keyup change paste",".js_add_comment",function(){validate_list_empty(JSON.parse($(this).attr('data-validation_details')));});$(document).on('click','.js_comment_menu_trigger',function(){$('.comment_actions').hide();$(this).next('.comment_actions').slideDown();});$(document).on('click','.comment_actions a',function(){$('.comment_actions').hide();});$('body').on('click',function(e){var target=$(e.target);if(!(target.className=='comment_actions'||target.parents('.comment_actions').length)){$('.comment_actions').slideUp();}});$(document).on("click",".js_post_comment_button",function(){var parent_form=$(this).parents('.the_form:first'),post_button=$(this);post_button.attr('disabled',true);var options={type:'POST',success:function(responseText,statusText,xhr,$form){var main_reply_to=$form.find("#main_reply_to").val(),reply_to=$form.find("#reply_to").val(),comment_id=$form.find("#comment_id").val();if(reply_to!=0){var ul_parent=$("[data-comment_type='main'][data-comment_id='"+main_reply_to+"'] .js_replies_ul");$(".js_reply_div").before($(responseText));$("li.js_comments:eq( "+0+" )",ul_parent).hide().fadeIn('slow');$(".js_reply_div").remove();}else{if(comment_id!=0){$(".js_wysiwyg_printout[data-comment_id='"+comment_id+"']").hide().html(responseText).fadeIn('slow');$(".js_edit_div").remove();}else{$("#the_form #comment").autogrow();$("#post_comment_div").after($(responseText));}}
$('[data-toggle="tooltip"]').tooltip();if($('.js_confirm_action_popover_vendor').length==0){if('function'===typeof initConfirmActionPopovers){initConfirmActionPopovers();}}
validate_list_empty(JSON.parse($('.js_add_comment',parent_form).attr('data-validation_details')));$('.js_wysiwyg_printout').addClass('comment_body');$('.js_comment_header_div').css("display",'');},clearForm:true,resetForm:true};parent_form.ajaxForm(options);if(parent_form.valid()){parent_form.submit();}});$('[data-toggle="popover"]').click(function(e){$('[data-toggle="popover"]').not(this).popover('hide');});});function update_indicators()
{var approve_membership_id=$('#moderationModal #membership_moderation_id').val();var newTotalPendingComments=parseInt($('.js_pending_comments_indicator:first').text())-1,new_pending_comments=parseInt($('#moderationModal #total_unapproved_comments').val())-1;$('#moderationModal #total_unapproved_comments').val(new_pending_comments);var current_pending_comments=$('#moderationModal .js_unmoderated_comments_ul li.js_comments').length;var membership_current_comments=$('.js_pending_comments_indicator_membership[data-membership_id="'+approve_membership_id+'"]').text();$('.js_pending_comments_indicator').text(newTotalPendingComments);$('.js_pending_comments_indicator_membership[data-membership_id="'+approve_membership_id+'"]').text(current_pending_comments);var tooltip_content=$('.js_box_popover[data-membership_id="'+approve_membership_id+'"]').attr('data-content');tooltip_content=tooltip_content.replace('<span class=\'main_messages js_pending_comments_indicator_membership\'>'+membership_current_comments+'</span>','<span class=\'main_messages js_pending_comments_indicator_membership\'>'+current_pending_comments+'</span>');$('.js_box_popover[data-membership_id="'+approve_membership_id+'"]').attr('data-content',tooltip_content);if(current_pending_comments==0){$('.js_pending_comments_indicator_membership[data-membership_id="'+approve_membership_id+'"]').parent('.notification_badge').hide();tooltip_content=tooltip_content.replace('js_unapproved_comments_icon','js_unapproved_comments_icon not_clickable').replace('notification_badge','notification_badge semi-white');}
if(new_pending_comments==0){$("#moderationModal").modal("hide");}
if(newTotalPendingComments==0){$('.js_pending_comments_indicator').parent('.notification_badge').hide();}
var popover=$('.js_box_popover[data-membership_id="'+approve_membership_id+'"]').data('popover');popover.options.content=tooltip_content;}
function generate_form(div_id,action,comment_id,reply_to)
{var extra_div_class="js_edit_div";var form_template=$("#the_form").clone();form_template.removeAttr("id").attr("id","edit_small_comment").show();form_template.addClass("edit_small_comment");form_template.attr("action",action);form_template.find("#comment_id").val(comment_id);form_template.find("#reply_to").val(reply_to);form_template.wrap("<div>");form_template.parent().attr("id",div_id);form_template.parent().addClass("js_comments");$('.js_add_comment',form_template).attr('data-validation_details','{"selector": ".js_wysiwyg_printout .js_add_comment", "button": ".js_comments .js_post_comment_button"}');if(reply_to>0){extra_div_class="js_reply_div";}
form_template.parent().addClass(extra_div_class);return form_template.parent();}
function br2nl(str){return str.replace(/<br\s*\/?>/mg,"\n");}
function nl2br(str){return str.replace(/\n/mg,"<br>");}
function empty_br(str){return str.replace(/<br\s*\/?>/mg,"");}
function empty_nl(str){return str;}
function deleteComment($button)
{$("#small_reply_live").remove();$button.attr("disabled",true);var comment_id=$button.attr("data-comment_id");$.ajax({url:window['jsVars']['portal_path']+"delete_comment/",type:"POST",data:{comment_id:comment_id}}).done(function(data){$(".js_comments[data-comment_id='"+comment_id+"']").addClass("red_bg_highlight_1x");$('.js_confirm_action_popover').popover('hide');if($('.js_confirm_action_popover_vendor').length){$('.js_confirm_action_popover_vendor').tooltipster('hide');}
setTimeout(function(){if($('.js_comments_approve_modal_div').length>0){var $comment_container=$(".js_comments[data-comment_id='"+comment_id+"']"),$post_container=$comment_container.parents('.js_comments_approve_modal'),$removing_container=$comment_container;if($post_container.find('.js_comments').length===1){$removing_container=$post_container;}
$removing_container.fadeOut("normal",function(){$(this).remove();update_indicators();});}else{$(".js_comments[data-comment_id='"+comment_id+"']").fadeOut(300,function(){$('[data-toggle="tooltip"]').tooltip('hide');$(this).remove();});}},1000);})}